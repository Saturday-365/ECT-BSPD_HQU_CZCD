# ECT-BSPD_HQU_CZCD
华侨大学承志赛车队电控电子节气门规则及自制BSPD工程
## 电子节气门过检相关内容
### 全车继电器分配 
* 本队采用了两个继电器串联控制安全回路，一个继电器由全车3个急停开关、惯性开关、制动超程开关、BSPD进行控制；还有一个继电器由ECU进行控制。只有当两个继电器全部吸合时，整车安全回路才会闭合，喷油点火继电器被激活。油泵的继电器得到电源输入。      
* 针对电子节气门，除了ECU本身需要的一个电源控制继电器，由于此继电器无法接受用户的自定义控制，我们还增加了一个继电器串入电子节气门电源用于控制电子节气门电源。   
* 因此全车一共7个继电器 1、喷油/点火；2、油泵；3、风扇；4、安全回路；5、ECU控制安全回路；6、电子节气门；7、用户控制电子节气门电源
### 继电器控制逻辑
通过查看ECU文件的数字区块及辅助输出控制可以知晓本队的过检流程及控制逻辑
* 数字区块为LINK ECU 的逻辑控制部分，可以自定义输入参数，并设置公式，当满足某些条件时，输出一个bool信号 即0或者1；类似于编程语言中的 if 条件语句
* 辅助输出为LINK ECU 的输出端口 一般用于继电器的控制，LINK ECU提供了 3个可供选择的参数输入，可以供用户设定 当对应参数等于或大于或小于某个值时 触发相应鸡蛋起
### 通用输出2 ECU Ctrl SafetyCiru
本辅助输出控制ECU安全回路继电器，由数字区块5、6 及电子节气门电源状态控制
当数字区块5或6被触发或电子节气门电源不活跃时关闭此继电器，达到关闭安全回路的目的。
* 数字区块5 输入参数为TPS值与制动压力，当制动压力电压大于1.5V TPS大于20 时触发
* 数字区块6 输入参数为 数字区块3和数字区块4 任意一个数字区块触发则触发数字区块6 而数字区块3和4分别为tps 和 aps 的电压检测，当任意一个tps信号或aps信号丢失时，这些数字区块会被触发；因此数字区块6可以称为tps aps信号检测 任意信号丢失则触发数字区块6
* 电子节气门电源状态 ECU内部存在一些保证电子节气门安全的逻辑，如当tps无法达到期望值，即tps与目标值不符时间超出错误阈值，ECU会自行关闭电子节气门电源，又如当两个tps信号或者aps信号存在较大差值时，ECU也会自行关闭电子节气门电源，这一判断条件就是保证，当上述情况发生时，整车的安全回路会被断开，喷油点火油泵电源会被断开

### 通用输出3 ECT Power Ctrl 
本辅助输出控制用户自行添加的电子节气门电源继电器，主要针对制动信号丢失后对电子节气门的相关控制，即，当制动压力信号低于0.1V（一般正常值为1V）时，认为制动压力信号丢失，此时控制此继电器关闭电子节气门电源 

以上为本队完善电子节气门相关规则使用到的相关逻辑

### [BSPD_Project)](https://github.com/Saturday-365/CZCD_EE-Department_Main/tree/main/3-PCB)  
此PCB文件为按照2023款的super速迫BSPD原理图进行自制的嘉立创EDA工程文件，本设计在原有的基础上增加了一个LDO芯片采用两个LDO并联输出，以期望减小芯片发热量以增强整个模块的稳定性。以经过2025赛季检验。欢迎各家车队参考，自制的话成本很低，买次一物料至少能焊出来3-4块。
### 4、[BSPD PCB(4-文稿)](https://github.com/Saturday-365/CZCD_EE-Department_Main/tree/main/4-%E6%96%87%E7%A8%BF) 
过检证明材料、需要提交赛会的文件、等等其他用得着的文件材料等等
### 5、[MatLab(5-MATLAB处理数据)](https://github.com/Saturday-365/CZCD_EE-Department_Main/tree/main/5-MATLAB%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE) 
MatLab相关文件数据

## 日志
| 日期 | 日志 |
| :---: | :--- |
| <i><b>2025.8.29 | 1、确定仪表User LED用法<br>2、确定ECU控制继电器方式 |
| <i><b>2025.8.30 | 1、HQU15V3 焊接完成 <br>2、完善电控模块部分 等待线束接完后进行测试<br>3、明天完成线束后开始调试datacan |
| <i><b>2025.8.31 | 1、线束测试完成，继电器处 油泵 节气门不支持高侧控制 需要单独修改为低侧控制 <br>2、添加一个指示灯 用于显示ECU对于安全回路的控制状态 及 只有当两个灯亮起时才有完整的安全回路<br>3、明天完成仪表处的相关线束按键等、准备调试datacan |
| <i><b>2025.9.01 | 1、指示灯添加完成 现在仪表上只有两个绿色灯亮起后才表示安全回路完全闭合<br>2、仪表完成翻页按钮配置，并与集成板配合完善UserLED，后续任务为美化完善界面<br>3、DATAcan完全调试完成，现在所有数据均可正确显示<br> 今天完善datacan后切了一下午的碳板，真难搞，车身也在切碳纤维，去年展厅全是玻纤，弄得手痒死，今年好了，全是碳纤维，哎每天手都感觉是肿的。。。 |
| <i><b>2025.9.02 | 1、公母端子买错了 今天没有做线只是把关节电机的线焊接了|
| <i><b>2025.9.03-04 | 1、线束上车 点火测试 一把就着 <br>2、部分线束长度不够，主要是 挡传特殊接地，电子节气门线束 主开关线束 不够长 目前采用延长线，后续得想其他办法<br>3、今天上车时主开关一次带电，在接触到离合电机支撑板时发生短路（火花四溅），触发了电池的保护（现象为 电池电压低于未保护是电压 切上电后电池无带载能力，电压降至1.多伏），查阅电池说明书后 断开电池输出后解除保护<br>4、电控集成盒存在问题 1、盒子无散热措施，今年打开后发现非常热 但是也是因为开了很多个小时一直在给电池充电 烧了我一个无线下载器很难过<br>5、修改了仪表程序，完善了ECU程序|
| <i><b>2025.9.05-06 | 1、5日凌晨准备跑动测试，热车完成后再次点火打不燃了，后来发现是二缸内存在机油，这两天动力组的同学正在检修<br>2、5日把电机支架安装上了|
| <i><b>2025.9.07-14 | 1、动力组把发动机换了个变，还是存在冷车着热车不着，在赤兔测了又测，火花塞都断在发动机里面了，回去查，发现是新买的油泵有问题，无法锁住升起来的油压<br>2、换了油泵还是点不着，动力组的同学没有办法了，我又把标定线束拿出来装上，诶，可以点着了，wow你也觉得是线束问题吧，当天，从晚上查到第二天早上10点，您猜怎么找，凸轮轴传感器，*在8月份的某一天被460固定了，热车时候被某人说拿460固定的传感器位置不对了，相当于发动机没有正时信号，发动机不喷油不电火，解释了一切问题。之前标定线束能点着，纯纯是因为，标定线束会扯着凸轮轴传感器，让它的位置刚好处在正确的位置 <!--__我只能说动力组WOCNM__-->* （0929在后续购买了全新的凸轮轴传感器后，发现是凸轮轴传感器本身的问题，旧的凸轮轴传感器本身的卡口出现松动，导致信号时有时无，全新的凸轮轴传感器修复了这个问题，变成了一体式的）<br>3、后面几天开学了，再做一般集成板，消除物理上的干涉，再做一个集成盒，试着跟现成的防水盒搭配|
| <i><b>2025.9.15 | 出车修改了一些程序|
| <i><b>2025.9.19 | 感谢阿迈斯的帮助|
| <i><b>2025.9.20 | 1、完善制动压力线束，使ECU可以读取到制动压力<br>2、重做电子节气门线束，增加过检需要的接插件<br>3、完善仪表四周按键，目前换挡总成的电源可以被前舱控制<br>4、实车修改过检程序通过一个由ECU控制的安全回路继电器完成大部分电子节气门规则<br>5、下一步熟读节气门失效分析、并依次对照规则完善最终版程序<br>6、后续完善一版电池盒及电控总成的设计确保万无一失|
| <i><b>2025.9.28 | 1、上次是在雨天，改完程序就撤退了，后来天气好了，应该是周天也就是21号，去还是打不着，一直在排查问题，最后认为是曲轴信号因为转速不稳一直无法正常触发，导致ecu同步状态一直为“seek”只能找到first gap及第一个缺齿，听声音也有明确的区别，与正常的发动机声音不同，视频该会留在本工程里，所以在22号周一下午下课后，去赤兔换了一个启动电机，诶就可以打着了于是当天就撤退了<br>2、下一次就是周五26号 准备拉马力机，拉马力机过程中，启动电机还是打不着，声音频率特别低，全程靠着马力机那边搭电才给发动机点着，当天回来，拆下了凸轮轴传感器准备安装,安装时出现问题凸轮轴会顶到凸轮轴传感器，凸轮轴传感器没粘住一拔就掉了，所以再等一天重新定位置，重新粘，于是就到了28号<br>3、27号晚上粘好之后，换了飞客赞助的全新电池，还是必须接充电器，充到14v多才能点着，等第二天，28号早上，用电池加充电器也是可以点着的，在赤兔，前几次也是可以点着的，后面越来越点不着，试了各种办法，把三明好哥们的电池也借过来，危险操作也还是没有办法，但是不能再耽误时间了，于是，推发，着了，开跑，11分钟，在第8-9分钟的时候开始没动力了，随即过温，拉缸，启动电机卡死，今晚拆来，二缸拉瓦，一缸拉缸 *<!--这个比赛打到现在，纯纯心态的磨练，纯纯是工程上解决各种问题能力的磨练，真的很累真的很苦，希望所以能打智能车的就去打智能车吧，别来碰这个烧钱，花钱，不给报销，超级无敌累的比赛了-->*愿后续顺利，目前是等后天原厂机回来，再装上练车|
| <i><b>2025.10.01 |1、又是一年国庆上班时间，今天接了轮速传感器和限位移传感器，完善了最终版本的电池盒（最近几天干的）ASA98块一卷好贵，最新的电池盒完美符合规则要求|
| <i><b>2025.10.02 |1、今天原厂机回来了，装上去接线，一把着很舒服，很开心，明天要练车了，加油💪|
| <i><b>2025.10.03 |1、今天练车一切顺利|
| <i><b>2025比赛日|1、电控一切顺利，直线加速上大分 高避耐久一切正常 <br>祝贺华侨大学承志车队获得队史最佳好成绩|

## 设计报告
### 4.1 电控换挡、无线数据透传设计 
    本队设计了一个基于STM32F407单片机及小米CyberGear关节电机的电控换挡系统，本系统除电机外的软件及硬件均自行设计制作
    首先是硬件部分 
        硬件上 本队利用立创 EDA 软件设计PCB将数据传输模块以及换挡控制模块集成在一块电路板上，以提高各模块工作的 
        稳定性以及电控模块的硬件结构简化。本队的数据传输采用 TJA1050芯片，读取 ECU 发出的 CAN 总线上的数据，传输到单片机后由单片机解析其数据并将其通过 RS232 总线发送至电台，在最远 8KM 的距离上由接收电台和上位机实现在场外对车上数据的实时监控及记录。电机控制部分，本队自行设计了F407单片机核心版，以满足小体积，可自适应本队需求等要求。同时设计了按键消抖，输出缓冲隔离电路，适应车规级需求。
    软件上则分为三个部分
    第一部分 车辆状态信息采集
        本队通过读取ECU传输出来的CAN信号，自行在单片机中编写代码解析车辆状态信息，包含轮速、档位、转速等信息。通时通过F407的另外一条CAN通道，实现换挡电机的信息采集，包括温度，扭矩，速度等信息。
    第二部分 信息处理
        对于ECU信号，解析过程完成后会通过与PCB链接的电台广播，再由上位机接收，便于车辆运行过程中对车辆状态进行感知。
        对于档位信号，由于换挡过程中，不同档位之间的切换需要换挡电机转动的位置不同，因此需要读取准确的档位信息，而在测试过程中，档位信号存在不正常跳动，及升降档过程中跳空档的问题，导致换挡过程中无法准确判断档位信息，因此本队编写相关算法，对挡传信号进行滤波，实现挡传信号稳定，及准确，消除了不正常的跳动及升档跳空挡的问题，便于后续步骤处理
    第三部分 电机控制
        电机控制部分，通过CAN通信与关节电机通信，控制关节电机完成相应的动作，换挡过程全部采用闭环控制，通过状态机精确控制电机的每一步操作。单独调试每一个档位下的电机转动位置及速度扭矩，断火时间，补油时间等参数，以达到期望的换挡效果

### 4.2 整车线束设计 
    本队的整车线束利用 EPLAN HARNESS PROD 软件在三维模型上进行模拟布线，即可得知每根线的各项 
    信息，并对每根线的长度、颜色、名称与其定义一一对应，最后整理得到全车的线束三维模型。此外，此 
    模型还可精确到每根线所连接的针脚，以此解决线束寻找针脚位置困难的问题，极大提高了线束制作效率。
### 4.3 辅助驾驶系统设计
    本队的辅助驾驶系统包括EBD、风扇自启动、升档断火、降档补油。
    风扇自启动以ECU读取的发动机水温为依据，当水温大于80度时输出信号使风扇启动。
    升档断火降档补油的控制通过单片机在给出换挡信号的同时向ECU发送断火或补油信号，再通过ECU调控发动机做出相应的改变。
    以上控制可帮助车手在驾驶时集中精力、减少车手额外操作。
<!-- 
#### 四级标题  
##### 五级标题  
###### 六级标题 
二、编辑基本语法  
1、字体格式强调
 我们可以使用下面的方式给我们的文本添加强调的效果
*强调*  (示例：斜体)  
 _强调_  (示例：斜体)  
**加重强调**  (示例：粗体)  
 __加重强调__ (示例：粗体)  
***特别强调*** (示例：粗斜体)  
___特别强调___  (示例：粗斜体)  
2、代码  
`<hello world>`  
3、代码块高亮  
```
@Override
protected void onDestroy() {
    EventBus.getDefault().unregister(this);
    super.onDestroy();
}
```  
4、表格 （建议在表格前空一行，否则可能影响表格无法显示）
 
 表头  | 表头  | 表头
 ---- | ----- | ------  
 单元格内容  | 单元格内容 | 单元格内容 
 单元格内容  | 单元格内容 | 单元格内容  
 
5、其他引用
图片  

链接  
[链接名称](https://www.baidu.com/)    
6、列表 
1. 项目1  
2. 项目2  
3. 项目3  
   * 项目1 （一个*号会显示为一个黑点，注意⚠️有空格，否则直接显示为*项目1） 
   * 项目2   
 
7、换行（建议直接在前一行后面补两个空格）
直接回车不能换行，  
可以在上一行文本后面补两个空格，  
这样下一行的文本就换行了。
或者就是在两行文本直接加一个空行。
也能实现换行效果，不过这个行间距有点大。  
 
8、引用
> 第一行引用文字  
> 第二行引用文字  
———————————————— -->